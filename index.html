<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
<title></title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 

<link rel="stylesheet" href="./css/leaflet-search.css" />
<link rel="stylesheet" href="./css/style.css" />
<link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />

<style>
.search-input {
	font-family:Courier
}
.search-input,
.leaflet-control-search {
	max-width:400px;
}
</style>
</head>

<body>

<div id="map"></div>
<form name="form">
<label id="refreshButton1" >
<input  type="radio"  name="topten" class="radio" value="Movies" checked/> Movies
</label>
<label id="refreshButton2" >
<input  type="radio" name="topten" class="radio" value="TV"> TV
</label>
</form>
</body>

<script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
crossorigin=""></script>
<script src="./js/leaflet-search.js"></script>

<script>



var data,map, rScale,geojson,dataCurrent,countryClicked,countryClickedData,clicked;
function initMap(){
	map = new L.Map('map', {worldCopyJump:true,minZoom:3,zoom: 3, center: new L.latLng([41.575730,13.002411]) });

	
	map.addLayer(new L.TileLayer('https://api.mapbox.com/styles/v1/dktaybw/cldx6649800g301qqurfbdhyy/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiZGt0YXlidyIsImEiOiJjbDlkenBvODMwa2twM3hvZ293bWVpaml1In0._QB63ZC3km-uev6mJkmacg'));
	
	map.addControl( new L.Control.Search({
		url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
		jsonpParam: 'json_callback',
		propertyName: 'display_name',
		propertyLoc: ['lat','lon'],
		marker: L.circleMarker([0,0],{radius:0 }),
		autoCollapse: true,
		autoType: false,
		minLength: 2,
		zoom:11
	}) );
	(function () {
  var control = new L.Control();
  control.onAdd = function (map) {
    var azoom = L.DomUtil.create("a", "resetzoom");
    azoom.innerHTML = "[Reset Zoom]";
    L.DomEvent.disableClickPropagation(azoom).addListener(
      azoom,
      "click",
      function () {
        map.setView(map.options.center, map.options.zoom);
		d3.select('.toptenlist').selectAll('text').remove();
		if (document.getElementsByClassName('leaflet-interactive active')[0] == undefined){

}
else{
	document.getElementsByClassName('leaflet-interactive active')[0].classList.remove('active')
}

      },
      azoom
    );
    return azoom;
  };
  return control;
})().addTo(map);

topTenData();
addBorders();

}

function addBorders(){
	var myStyle = {
	"fillOpacity":"0",
	"z-index":"0",
	"weight":".1",
	"color":"white",
	'id':'countries'
	
};

	d3.json('./data/countries_v4.geojson').then(function(borders){
		geojson=borders
	L.geoJSON(borders,{
		style:myStyle,
		onEachFeature: onEachFeature
	}).addTo(map).bringToBack();
}
)
}

function highlightFeature(e) {
    var layer = e.target;
	
	layer.setStyle({ 
		"weight":"2",
		"color":"#CCFBFE"
	})
	



}

function resetHighlight(e) {
	var layer = e.target;
	
	layer.setStyle({ 
	"weight":".1",
	"color":"white"
	})
	

	

}




function zoomToFeature(e) {
	
	

if (document.getElementsByClassName('leaflet-interactive active')[0] == undefined){

}
else{
	document.getElementsByClassName('leaflet-interactive active')[0].classList.remove('active')
}

	
	
	d3.select('.toptenlist').selectAll('text').remove()

    map.flyToBounds(e.target.getBounds(),{ duration: 1.5 });

	
	countryClicked = e.target.feature.properties.ISO_A2_EH
	console.log(countryClicked)
	if (document.getElementsByClassName('radio')[0].checked){
	makeTopTenList(countryClicked,'Movies')
	}
	else{
		makeTopTenList(countryClicked,'TV')
	}

	this.getElement().classList.add('active')
	
	console.log(this.getElement().classList)
	


}

function onEachFeature(feature, layer) {
    layer.on({
       /* mouseover: highlightFeature,
        mouseout: resetHighlight,*/
        click: zoomToFeature,
		
    });
}

function topTenData(){
	
	d3.tsv('./data/all-weeks-countries.tsv').then(function(d){
		dataCurrent = d
		
	})
	
}

function getData(){
	d3.csv('https://raw.githubusercontent.com/dktaylor916/606_netflixmap/main/data/oca_combined.csv')
  .then(function(csv) {
  data = csv;
  
  
	
  addMarkers();
  addLegend();
  topTenList();
});

}

function addMarkers(){
var max = d3.max(data,function(d){return d.total_ocas})
  
  rScale = d3.scaleLinear()
    .domain([1, max])
    .range([3, 7]);
  data.forEach(function(d) {
    var marker = L.circleMarker([+d.latitude, +d.longitude]);
	
	marker.setStyle({
		radius: rScale(d.total_ocas),
		color: '#E21221',
		weight: 1,
		fillColor: 'white',
		fillOpacity: .8
	});
	
	marker.bindPopup("<b>Total OCA's:</b> "+d.total_ocas)

    marker.addTo(map).bringToFront();
  })
}

function addLegend(){
	
	var legend = L.control({ position: "bottomleft" });
	legend.onAdd = function(map) {
	var div = L.DomUtil.create("div", "legend");
	return div;
	};
	legend.addTo(map);

	var legendSVG = d3.select('.legend')
	.append('svg')
	.attr('width',100)
	.attr('height',110)

	var totalOcas = data.map(function(d){
		return d.total_ocas
	})

	

	legendSVG
	.append('circle')
	.attr('cx',20)
	.attr('cy',10)
	.attr('r',rScale(1))
	legendSVG
	.append('circle')
	.attr('cx',20)
	.attr('cy',25)
	.attr('r',rScale(50))
	legendSVG
	.append('circle')
	.attr('cx',20)
	.attr('cy',45)
	.attr('r',rScale(150))
	legendSVG
	.append('circle')
	.attr('cx',20)
	.attr('cy',75)
	.attr('r',rScale(300))

	d3.selectAll('circle').attr('fill','#E21221').attr('stroke','white').attr('opacity',.8).attr("transform", "translate(" + 0 + ", " + 15 + ")")

	legendSVG
	.append('text')
	.attr('x',43)
	.attr('y',12)
	.text('1')
	legendSVG
	.append('text')
	.attr('x',40)
	.attr('y',30)
	.text('50')
	legendSVG
	.append('text')
	.attr('x',38)
	.attr('y',50)
	.text('150')
	legendSVG
	.append('text')
	.attr('x',38)
	.attr('y',80)
	.text('300')
	legendSVG
	.append('text')
	.attr('x',0)
	.attr('y',105)
	.text('Total OCAs')
	
	d3.selectAll('text').attr('fill','white').attr("transform", "translate(" + 0 + ", " + 15 + ")")
	
	legendSVG
	.append('text')
	.attr('x',0)
	.attr('y',10)
	.attr('fill','white')
	.text('Total OCAs')
	
	
 }

function topTenList(){
	var list = L.control({ position: "topright" });
	list.onAdd = function(map) {
	var div = L.DomUtil.create("div", "list");
	return div;
	};
	list.addTo(map);

	var listSVG = d3.select('.list')
	.append('svg')
	.attr('width','22vw')
	.attr('height','30vh')
	.attr('class','toptenlist')


}

function makeTopTenList(countryClicked,whichData){
	
	var tData
	countryClickedData = d3.filter(dataCurrent,function(data){return data.country_iso2==countryClicked}).slice(0,20)
	console.log(countryClickedData)
	var movies = countryClickedData.slice(0,10)
	var tv = countryClickedData.slice(10,20)

	if (whichData == 'Movies'){
		tData = movies
	} 
	else{
		tData = tv
	}

	d3.selectAll('.toptenlist')
	.selectAll('text')
	.data(tData)
	.enter()
	.append('text')
	.attr('class','mot')
	.attr('x',0)
	.attr('y',function(d,i){return i * 20 +40})
	.attr('fill','white')
	.attr('font-size','1.5vh')
	.text(function (d){return d.weekly_rank +'. ' +d.show_title})

	d3.selectAll('.toptenlist')
	.append('text')
	.attr('x',0)
	.attr('y',20)
	.attr('fill','white')
	.attr('font-size','3vh')
	.text(countryClickedData[0].country_name)
}


initMap();
getData();

document.getElementsByClassName('radio')[0].addEventListener('click',function(){
	d3.selectAll('.toptenlist').selectAll('text').remove()
	makeTopTenList(countryClicked,this.value)
})

document.getElementsByClassName('radio')[1].addEventListener('click',function(){
	d3.selectAll('.toptenlist').selectAll('text').remove()
	makeTopTenList(countryClicked,this.value)
})



</script>





</body>
</html>
